# Диагностика проблем с верификацией кода

## Проблема

Пользователи получают ошибку "Неверный код подтверждения" при вводе правильного кода с почты.

## Возможные причины

1. **Проблема с Redis подключением** - код не сохраняется или не читается из Redis
2. **Проблема с типами данных** - код сохраняется как число, а сравнивается как строка
3. **Проблема с TTL (временем жизни)** - код истекает раньше времени
4. **Проблема с API URL** - неправильная маршрутизация запросов на продакшене

## Диагностические endpoints

### 1. Проверка базового статуса

```
GET /api/health
```

Возвращает информацию о переменных окружения и статусе сервера.

### 2. Проверка конкретного email

```
GET /api/health/verification?email=user@example.com
```

Показывает сохраненный код для конкретного email и источник данных (Redis или in-memory).

### 3. Тест полного потока

```
POST /api/health/verification
{
  "action": "test-flow",
  "email": "test@example.com"
}
```

Выполняет полный тест отправки и проверки кода.

### 4. Redis debug (только для development)

```
GET /api/debug/redis
POST /api/debug/redis
```

Диагностика Redis соединения и управление кодами.

## Исправления

### 1. Добавлено логирование

- Детальные логи в `/api/email` (POST и PUT)
- Логи в `/api/auth/verify-code`
- Логи в `emailService.verifyCode`

### 2. Fallback mechanism

- In-memory хранилище когда Redis недоступен
- Автоматическое переключение между Redis и in-memory

### 3. Нормализация данных

- Приведение кодов к строкам с trim()
- Дополнительные проверки типов

### 4. Увеличенное время жизни

- TTL увеличен с 3 до 5 минут
- Соответствующие изменения в UI

## Мониторинг в production

1. Проверить логи сервера для ошибок Redis
2. Использовать `/api/health` для проверки конфигурации
3. При проблемах с конкретным пользователем использовать `/api/health/verification?email=...`

## Environment Variables

Убедитесь, что установлены:

- `REDIS_URL` - URL для подключения к Redis
- `RESEND_API_KEY` - ключ для отправки email
- `NEXT_PUBLIC_API_BASE_URL` - базовый URL API (для server-side запросов)

## Fallback поведение

Если Redis недоступен, система автоматически переключается на in-memory хранилище:

- Коды сохраняются в памяти сервера
- Периодическая очистка истекших кодов
- Работает только в рамках одной инстанции сервера

## Что делать если проблема продолжается

1. Проверить `/api/health` - статус переменных окружения
2. Проверить логи сервера на ошибки Redis
3. Протестировать с помощью `/api/health/verification`
4. Если Redis недоступен, система должна работать через in-memory fallback
5. Проверить, что email корректно отправляется через Resend
